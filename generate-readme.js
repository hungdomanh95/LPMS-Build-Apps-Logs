// lpms-build-apps-logs/scripts/generate-readme.js
// Sinh README.md: hiá»ƒn thá»‹ 5 dÃ²ng log gáº§n nháº¥t cho má»—i app (báº£ng 5 cá»™t: ... | Link |)

const fs = require("fs");
const path = require("path");

// Cháº¡y script ngay trong thÆ° má»¥c lpms-build-apps-logs
const LOG_DIR = process.cwd();

// Khai bÃ¡o danh sÃ¡ch file + thÃ´ng tin hiá»ƒn thá»‹
const FILES = [
  { app: "Msales", env: "UAT",  file: "Msales_UAT.md",  color: "1f77b4", anchor: "msales-uat" },
  { app: "Msales", env: "PROD", file: "Msales_PROD.md", color: "e74c3c", anchor: "msales-prod" },
  { app: "Dsales", env: "UAT",  file: "Dsales_UAT.md",  color: "8e44ad", anchor: "dsales-uat" },
  { app: "Dsales", env: "PROD", file: "Dsales_PROD.md", color: "27ae60", anchor: "dsales-prod" },
];

// Header báº£ng 5 cá»™t (cá»™t cuá»‘i: Link)
const TABLE_HEADER =
  "| Date (VN) | App | Version | Description | Link |\n" +
  "|---|---|---|---|---|";

// Regex phÃ¡t hiá»‡n separator 5 cá»™t
const SEP_REGEX_5 = /^\|[- ]+\|[- ]+\|[- ]+\|[- ]+\|[- ]+\|$/;

function readFileSafe(absPath) {
  try { return fs.readFileSync(absPath, "utf8"); } catch { return ""; }
}

function makeBadgeURL(app, env, color) {
  return `https://img.shields.io/badge/${encodeURIComponent(app)}-${encodeURIComponent(env)}-${color}?style=for-the-badge&logo=android&logoColor=white`;
}

// Láº¥y 5 dÃ²ng dá»¯ liá»‡u ngay sau separator
function extractTopRows(md, count = 5) {
  if (!md) return [];
  const lines = md.replace(/\r\n/g, "\n").split("\n");

  const sepIdx = lines.findIndex(l => SEP_REGEX_5.test(l.trim()));
  if (sepIdx === -1) return [];

  const rows = [];
  for (let i = sepIdx + 1; i < lines.length; i++) {
    const line = (lines[i] || "").trim();
    if (!line || !line.startsWith("|")) break;
    rows.push(lines[i]); // giá»¯ nguyÃªn Ä‘á»‹nh dáº¡ng cell (cÃ³ badge Android/iOS trong cá»™t Link)
    if (rows.length >= count) break;
  }
  return rows;
}

function quickLinks() {
  const cells = FILES.map(info => {
    const badge = makeBadgeURL(info.app, info.env, info.color);
    return `<td width="25%"><a href="#${info.anchor}"><img alt="${info.app} ${info.env}" src="${badge}"/></a></td>`;
  }).join("\n    ");
  return `
## ğŸ”— Nhanh: Tá»›i file log

<table>
  <tr>
    ${cells}
  </tr>
</table>`;
}

function sectionFor(info) {
  const abs = path.join(LOG_DIR, info.file);
  const md = readFileSafe(abs);
  const rows = extractTopRows(md, 5);
  const table = rows.length ? [TABLE_HEADER, ...rows].join("\n") : `${TABLE_HEADER}\n| _No data_ |  |  |  |  |`;

  const badge = makeBadgeURL(info.app, info.env, info.color);

  return `
<a id="${info.anchor}"></a>
<h3>
  <img alt="${info.app} ${info.env}" src="${badge}" />
</h3>

<p>
  <a href="./${info.file}"><strong>â¡ï¸ Xem Ä‘áº§y Ä‘á»§ (${info.file})</strong></a>
</p>

${table}
`;
}

function buildREADME() {
  const header = `<!-- Auto-generated by scripts/generate-readme.js -->
<p align="center">
  <img src="https://img.shields.io/badge/Build-Logs-222?style=for-the-badge" alt="Build Logs"/>
</p>

<h1 align="center">ğŸ“¦ LPMS â€“ Build Apps Logs</h1>

> BÃªn dÆ°á»›i lÃ  <strong>5 dÃ²ng gáº§n nháº¥t</strong> cá»§a má»—i á»©ng dá»¥ng. Click á»Ÿ má»¥c <em>â€œNhanh: Tá»›i file logâ€</em> Ä‘á»ƒ cuá»™n xuá»‘ng báº£ng; trong má»—i block cÃ³ nÃºt <em>â€œXem Ä‘áº§y Ä‘á»§â€</em> Ä‘á»ƒ má»Ÿ file gá»‘c.
`;

  const sections = FILES.map(sectionFor).join("\n---\n");

  const footer = `
---

<p align="center">
  <sub>Latest-first Â· Made for MAFC</sub>
</p>
`;

  return [header, quickLinks(), sections, footer].join("\n\n");
}

function main() {
  const out = buildREADME();
  const outPath = path.join(LOG_DIR, "README.md");
  fs.writeFileSync(outPath, out, "utf8");
  console.log(`âœ… README.md generated at: ${outPath}`);
}

main();
