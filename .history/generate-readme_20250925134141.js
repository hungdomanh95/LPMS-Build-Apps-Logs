// lpms-build-apps-logs/scripts/generate-readme.js
// Sinh README.md: hi·ªÉn th·ªã 5 d√≤ng log g·∫ßn nh·∫•t cho m·ªói app (b·∫£ng 5 c·ªôt: ... | Link |)

const fs = require("fs");
const path = require("path");

// Ch·∫°y script ngay trong th∆∞ m·ª•c lpms-build-apps-logs
const LOG_DIR = process.cwd();

// Khai b√°o danh s√°ch file + th√¥ng tin hi·ªÉn th·ªã
const FILES = [
  { app: "Msales", env: "UAT",  file: "Msales_UAT.md",  color: "1f77b4", anchor: "msales-uat" },
  { app: "Msales", env: "PROD", file: "Msales_PROD.md", color: "e74c3c", anchor: "msales-prod" },
  { app: "Dsales", env: "UAT",  file: "Dsales_UAT.md",  color: "8e44ad", anchor: "dsales-uat" },
  { app: "Dsales", env: "PROD", file: "Dsales_PROD.md", color: "27ae60", anchor: "dsales-prod" },
];

// Header b·∫£ng 5 c·ªôt (c·ªôt cu·ªëi: Link)
const TABLE_HEADER =
  "| Date (VN) | App | Version | Description | Link |\n" +
  "|---|---|---|---|---|";

// Regex ph√°t hi·ªán separator 5 c·ªôt
const SEP_REGEX_5 = /^\|[- ]+\|[- ]+\|[- ]+\|[- ]+\|[- ]+\|$/;

function readFileSafe(absPath) {
  try { return fs.readFileSync(absPath, "utf8"); } catch { return ""; }
}

function makeBadgeURL(app, env, color) {
  return `https://img.shields.io/badge/${encodeURIComponent(app)}-${encodeURIComponent(env)}-${color}?style=for-the-badge&logo=android&logoColor=white`;
}

// L·∫•y 5 d√≤ng d·ªØ li·ªáu ngay sau separator
function extractTopRows(md, count = 5) {
  if (!md) return [];
  const lines = md.replace(/\r\n/g, "\n").split("\n");

  const sepIdx = lines.findIndex(l => SEP_REGEX_5.test(l.trim()));
  if (sepIdx === -1) return [];

  const rows = [];
  for (let i = sepIdx + 1; i < lines.length; i++) {
    const line = (lines[i] || "").trim();
    if (!line || !line.startsWith("|")) break;
    rows.push(lines[i]); // gi·ªØ nguy√™n ƒë·ªãnh d·∫°ng cell (c√≥ badge Android/iOS trong c·ªôt Link)
    if (rows.length >= count) break;
  }
  return rows;
}

// function quickLinks() {
//   const cells = FILES.map(info => {
//     const badge = makeBadgeURL(info.app, info.env, info.color);
//     return `<td width="25%"><a href="#${info.anchor}"><img alt="${info.app} ${info.env}" src="${badge}"/></a></td>`;
//   }).join("\n    ");
//   return `
// ## üîó Nhanh: T·ªõi file log

// <table>
//   <tr>
//     ${cells}
//   </tr>
// </table>`;
// }

function sectionFor(info) {
  const abs = path.join(LOG_DIR, info.file);
  const md = readFileSafe(abs);
  const rows = extractTopRows(md, 5);
  const table = rows.length ? [TABLE_HEADER, ...rows].join("\n") : `${TABLE_HEADER}\n| _No data_ |  |  |  |  |`;

  const badge = makeBadgeURL(info.app, info.env, info.color);

  return `
<a id="${info.anchor}"></a>
<h3>
  <img alt="${info.app} ${info.env}" src="${badge}" />
</h3>

<p>
  <a href="./${info.file}"><strong>‚û°Ô∏è Xem ƒë·∫ßy ƒë·ªß (${info.file})</strong></a>
</p>

${table}
`;
}

function buildREADME() {
  const header = `<!-- Auto-generated by scripts/generate-readme.js -->
<p align="center">
  <img src="https://img.shields.io/badge/Build-Logs-222?style=for-the-badge" alt="Build Logs"/>
</p>

<h1 align="center">üì¶ LPMS ‚Äì Build Apps Logs</h1>

> B√™n d∆∞·ªõi l√† <strong>5 d√≤ng g·∫ßn nh·∫•t</strong> c·ªßa m·ªói ·ª©ng d·ª•ng.
`;

  const sections = FILES.map(sectionFor).join("\n---\n");

  const footer = `
---

<p align="center">
  <sub>Latest-first ¬∑ Made by ƒê·ªñ H√ôNG</sub>
</p>
`;

  // return [header, quickLinks(), sections, footer].join("\n\n");
  return [header, sections, footer].join("\n\n");
}

function main() {
  const out = buildREADME();
  const outPath = path.join(LOG_DIR, "README.md");
  fs.writeFileSync(outPath, out, "utf8");
  console.log(`‚úÖ README.md generated at: ${outPath}`);
}

main();
